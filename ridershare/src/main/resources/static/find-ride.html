<!-- ==================== FIND-RIDE.HTML ==================== -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Ride - Campus Rideshare</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="container">
    <header class="header">
        <h1><a href="/" style="color: white; text-decoration: none;">ğŸš² Campus Rideshare</a></h1>
        <p id="user-greeting" style="margin-top: 10px;"></p>
    </header>

    <div style="background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ” Find a Ride</h2>

        <div id="alert-container"></div>

        <div class="form-group">
            <label for="search">Search by Destination</label>
            <input type="text" id="search" placeholder="e.g., Sector 17, Chandigarh">
            <button onclick="searchRides()" class="btn btn-primary btn-sm" style="margin-top: 10px;">Search</button>
            <button onclick="showAllRides()" class="btn btn-secondary btn-sm" style="margin-top: 10px;">Show All</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading rides...</p>
        </div>

        <div id="rides-container"></div>

        <div class="auth-links " style="margin-top: 30px;">
            <a href="/my-requests.html">ğŸ“‹ View My Requests</a> |
            <a href="/" onclick="logout(event)">Logout</a>
        </div>
    </div>
</div>

<script>
    const API_BASE = 'https://apna-vaahan.onrender.com/api';
let currentUser = null;
let refreshInterval = null;

async function init() {
    currentUser = JSON.parse(localStorage.getItem('user'));

    // Show greeting if logged in, otherwise show generic message
    if (currentUser) {
        document.getElementById('user-greeting').textContent = `Welcome, ${currentUser.name}!`;
        // Show logged-in options
        const authLinks = document.querySelector('.auth-links');
        if (authLinks) {
            authLinks.innerHTML = `
                <a href="/my-requests.html">ğŸ“‹ View My Requests</a> |
                ${currentUser.isRider ? '<a href="/rider-dashboard.html">ğŸï¸ My Dashboard</a> | ' : ''}
                <a href="/" onclick="logout(event)">Logout</a>
            `;
        }
    } else {
        document.getElementById('user-greeting').textContent = 'Browse available rides';
        // Show signup option
        const authLinks = document.querySelector('.auth-links');
        if (authLinks) {
            authLinks.innerHTML = `
                Want to request a ride? <a href="/signup.html">Signup/Login</a> |
                <a href="/">Back to Home</a>
            `;
        }
    }

    // Load rides immediately
    await showAllRides();

    // Set up auto-refresh every 10 seconds for browse page
    refreshInterval = setInterval(async () => {
        await showAllRides();
    }, 30000); // Refresh every 10 seconds
}

// Clean up interval when leaving page
window.addEventListener('beforeunload', () => {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});

async function showAllRides() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('rides-container');

    loading.style.display = 'block';
    container.innerHTML = '';

    try {
        const response = await fetch(`${API_BASE}/rides`, {
            credentials: 'include'
        });
        const rides = await response.json();

        loading.style.display = 'none';

        if (rides.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸš«</div>
                    <h3>No rides available</h3>
                    <p>Check back later or post your own ride!</p>
                </div>
            `;
            return;
        }

        rides.forEach(ride => {
            container.innerHTML += createRideCard(ride);
        });
    } catch (error) {
        loading.style.display = 'none';
        showAlert('Failed to load rides', 'error');
    }
}

async function searchRides() {
    const destination = document.getElementById('search').value.trim();
    if (!destination) {
        showAllRides();
        return;
    }

    const loading = document.getElementById('loading');
    const container = document.getElementById('rides-container');

    loading.style.display = 'block';
    container.innerHTML = '';

    try {
        const response = await fetch(`${API_BASE}/rides?destination=${encodeURIComponent(destination)}`, {
            credentials: 'include'
        });
        const rides = await response.json();

        loading.style.display = 'none';

        if (rides.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ”</div>
                    <h3>No rides found</h3>
                    <p>Try searching for a different destination</p>
                </div>
            `;
            return;
        }

        rides.forEach(ride => {
            container.innerHTML += createRideCard(ride);
        });
    } catch (error) {
        loading.style.display = 'none';
        showAlert('Search failed', 'error');
    }
}

function createRideCard(ride) {
    return `
        <div class="ride-card">
            <div class="ride-header">
                <div class="ride-info">
                    <h3>${ride.startLocation} â†’ ${ride.endLocation}</h3>
                    <p style="color: #718096; margin: 5px 0;">By ${ride.rider.name}</p>
                </div>
                <span class="status-badge status-${ride.status.toLowerCase()}">${ride.status}</span>
            </div>

            <div class="ride-details">
                <div class="detail-item">
                    <span class="detail-label">ğŸ“… Date</span>
                    <span class="detail-value">${ride.date}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">ğŸ• Time</span>
                    <span class="detail-value">${ride.time}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">ğŸ“ Distance</span>
                    <span class="detail-value">${ride.distanceKm} km</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">ğŸ’° Total Cost</span>
                    <span class="detail-value">â‚¹${ride.totalCost}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">ğŸ’º Seats</span>
                    <span class="detail-value">${ride.availableSeats} / ${ride.totalSeats}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">ğŸï¸ Vehicle</span>
                    <span class="detail-value">${ride.rider.vehicleModel || 'Two Wheeler'}</span>
                </div>
            </div>

            ${ride.status === 'OPEN' && ride.availableSeats > 0 ? `
                <button onclick="requestRide('${ride.id}')" class="btn btn-primary" style="width: 100%; margin-top: 15px;">
                    Request Ride
                </button>
            ` : ''}
        </div>
    `;
}

async function requestRide(rideId) {
    // Check if user is logged in
    if (!currentUser) {
        alert('Please signup/login as a rider or passenger first to request rides!');
        window.location.href = '/signup.html';
        return;
    }

    const destination = prompt('Where exactly do you want to go?');
    if (!destination) return;

    const seats = parseInt(prompt('How many seats do you need?', '1'));
    if (!seats || seats < 1) return;

    try {
        const response = await fetch(`${API_BASE}/requests`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                rideId: rideId,
                passengerDestination: destination,
                seatsRequested: seats
            })
        });

        const data = await response.json();

        if (response.ok) {
            showAlert('Request sent successfully! Waiting for rider approval.', 'success');
            showAllRides();
        } else {
            showAlert(data.message || 'Request failed', 'error');
        }
    } catch (error) {
        showAlert('Network error', 'error');
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => {
        alertContainer.innerHTML = '';
    }, 5000);
}

function logout(e) {
    e.preventDefault();
    localStorage.removeItem('user');
    window.location.href = '/';
}


fetch('/api/auth/me', { credentials: 'include' })
  .then(res => {
    if (!res.ok) throw new Error("Not logged in");
    return res.json();
  })
  .then(user => {
    document.getElementById('user-greeting').innerText =
      `Welcome, ${user.name}`;
  })
  .catch(() => {
    document.getElementById('user-greeting').innerText =
      'Welcome, Guest';
  });

// Initialize on page load
init();

</script>
</body>
</html>