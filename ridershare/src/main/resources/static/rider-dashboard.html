<!-- ==================== RIDER-DASHBOARD.HTML ==================== -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider Dashboard - Campus Rideshare</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="container">
    <header class="header">
        <h1><a href="/" style="color: white; text-decoration: none;">üö≤ Campus Rideshare</a></h1>
        <p id="user-greeting" style="margin-top: 10px;"></p>
    </header>

    <div style="background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h2 style="color: #667eea;">üèçÔ∏è My Rides</h2>
            <a href="/offer-ride.html" class="btn btn-primary">+ Post New Ride</a>
        </div>

        <div id="alert-container"></div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>

        <div id="rides-container"></div>

        <div class="auth-links" style="margin-top: 30px;">
            <a href="/find-ride.html">üîç Find Rides</a> |
            <a href="/" onclick="logout(event)">Logout</a>
        </div>
    </div>
</div>


<script>
    const API_BASE = 'https://apna-vaahan.onrender.com/api';
let currentUser = null;
let refreshInterval = null;

async function init() {
    currentUser = JSON.parse(localStorage.getItem('user'));
    if (!currentUser || currentUser.rider !== true) {
        window.location.href = '/find-ride.html';
        return;
        }
    document.getElementById('user-greeting').textContent = `Welcome, ${currentUser.name}!`;

    // Load data immediately
    await loadData();

    // Set up auto-refresh every 5 seconds
    refreshInterval = setInterval(async () => {
        await loadData();
    }, 30000); // Refresh every 30 seconds
}

async function loadData() {
    await loadMyRides();
    await loadRequests();
}

// Clean up interval when leaving page
window.addEventListener('beforeunload', () => {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});

async function loadMyRides() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('rides-container');

    loading.style.display = 'block';

    try {
        const response = await fetch(`${API_BASE}/rides/my-rides`, {
            credentials: 'include'
        });
        const rides = await response.json();

        loading.style.display = 'none';

        if (rides.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <h3>No rides posted yet</h3>
                    <p>Click "Post New Ride" to offer a ride!</p>
                </div>
            `;
            return;
        }

        container.innerHTML = '<h3 style="margin-bottom: 15px;">üìã Posted Rides</h3>';
        rides.forEach(ride => {
            container.innerHTML += createRideCard(ride);
        });
    } catch (error) {
        console.error('Error loading rides:', error);
        loading.style.display = 'none';
        showAlert('No ride posted yet', 'error');
    }
}

async function loadRequests() {
    try {
        const response = await fetch(`${API_BASE}/requests/received`, {
            credentials: 'include'
        });
        const requests = await response.json();

        if (requests.length > 0) {
            const container = document.getElementById('rides-container');
            container.innerHTML += '<h3 style="margin: 30px 0 15px 0;">üì® Ride Requests</h3>';
            requests.forEach(req => {
                container.innerHTML += createRequestCard(req);
            });
        }
    } catch (error) {
        console.error('Failed to load requests:', error);
    }
}

async function deleteRide(rideId) {
    if (!confirm("Are you sure you want to delete this ride?")) return;

    try {
        const response = await fetch(`${API_BASE}/rides/${rideId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
            showAlert("Ride deleted successfully", "success");
            await loadData(); // refresh list
        } else {
            showAlert(data.message || "Failed to delete ride", "error");
        }
    } catch (err) {
        console.error(err);
        showAlert("Network error", "error");
    }
}


function createRideCard(ride) {
    return `
        <div class="ride-card">
            <div class="ride-header">
                <div class="ride-info">
                    <h3>${ride.startLocation} ‚Üí ${ride.endLocation}</h3>
                </div>

                <div style="display:flex; gap:10px; align-items:center;">
                    <span class="status-badge status-${ride.status.toLowerCase()}">${ride.status}</span>

                    <button onclick="deleteRide('${ride.id}')"
                            title="Delete ride"
                            style="
                                background:none;
                                border:none;
                                cursor:pointer;
                                font-size:18px;
                                color:#e53e3e;">
                        ‚ùå
                    </button>
                </div>
            </div>


            <div class="ride-details">
                <div class="detail-item">
                    <span class="detail-label">üìÖ Date</span>
                    <span class="detail-value">${ride.date}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">üïê Time</span>
                    <span class="detail-value">${ride.time}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">üìè Distance</span>
                    <span class="detail-value">${ride.distanceKm} km</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">üí∞ Cost</span>
                    <span class="detail-value">‚Çπ${ride.totalCost}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">üí∫ Seats</span>
                    <span class="detail-value">${ride.availableSeats} / ${ride.totalSeats}</span>
                </div>
            </div>

            ${ride.status === 'OPEN' ? `
                <button onclick="completeRide('${ride.id}')" class="btn btn-secondary btn-sm" style="margin-top: 10px;">
                    Mark as Completed
                </button>
            ` : ''}
        </div>
    `;
}

function createRequestCard(request) {
    return `
        <div class="ride-card">
            <div class="ride-header">
                <div class="ride-info">
                    <h3>Request from ${request.passenger.name}</h3>
                    <p style="color: #718096; margin: 5px 0;">Roll: ${request.passenger.rollNumber}</p>
                </div>
                <span class="status-badge status-${request.status.toLowerCase()}">${request.status}</span>
            </div>

            <div class="ride-details">
                <div class="detail-item">
                    <span class="detail-label">üìç Going to</span>
                    <span class="detail-value">${request.passengerDestination}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">üí∫ Seats</span>
                    <span class="detail-value">${request.seatsRequested}</span>
                </div>
                ${request.status === 'ACCEPTED' ? `
                <div class="detail-item">
                    <span class="detail-label">üìû Phone</span>
                    <span class="detail-value">${request.passenger.phone}</span>
                </div>
                ` : ''}
            </div>

            ${request.status === 'PENDING' ? `
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="acceptRequest('${request.id}')" class="btn btn-primary btn-sm" style="flex: 1;">
                        ‚úì Accept
                    </button>
                    <button onclick="rejectRequest('${request.id}')" class="btn btn-danger btn-sm" style="flex: 1;">
                        ‚úó Reject
                    </button>
                </div>
            ` : ''}
        </div>
    `;
}

async function acceptRequest(requestId) {
    try {
        const response = await fetch(`${API_BASE}/requests/${requestId}/accept`, {
            method: 'PUT',
            credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
            showAlert('Request accepted!', 'success');
            // Reload data immediately instead of page reload
            await loadData();
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        console.error('Error accepting request:', error);
        showAlert('Network error', 'error');
    }
}

async function rejectRequest(requestId) {
    if (!confirm('Are you sure you want to reject this request?')) return;

    try {
        const response = await fetch(`${API_BASE}/requests/${requestId}/reject`, {
            method: 'PUT',
            credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
            showAlert('Request rejected', 'info');
            // Reload data immediately
            await loadData();
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        console.error('Error rejecting request:', error);
        showAlert('Network error', 'error');
    }
}

async function completeRide(rideId) {
    if (!confirm('Mark this ride as completed?')) return;

    try {
        const response = await fetch(`${API_BASE}/rides/${rideId}/status?status=COMPLETED`, {
            method: 'PUT',
            credentials: 'include'
        });

        if (response.ok) {
            showAlert('Ride marked as completed!', 'success');
            await loadData();
        } else {
            showAlert('Failed to update ride status', 'error');
        }
    } catch (error) {
        console.error('Error completing ride:', error);
        showAlert('Network error', 'error');
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => {
        alertContainer.innerHTML = '';
    }, 5000);
}

function logout(e) {
    e.preventDefault();
    localStorage.removeItem('user');
    window.location.href = '/';
}

// Initialize on page load
init();

    function confirmDeleteRide(rideId) {
    if (!confirm("Are you sure you want to delete this ride?")) {
        return;
    }

    console.log("DELETE RIDE ID:", rideId);
    alert("Delete clicked for ride: " + rideId);
}
</script>
</body>
</html>